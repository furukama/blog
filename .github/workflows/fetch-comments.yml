name: Fetch Bluesky Comments

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  fetch-comments:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install atproto pyyaml requests
      
      - name: Fetch comments from Bluesky
        env:
          # Bluesky
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
        run: |
          python3 << 'EOF'
          import os
          import yaml
          import json
          from atproto import Client as BlueskyClient
          from datetime import datetime
          import glob
          
          # Initialize Bluesky client
          bluesky = BlueskyClient()
          if os.environ.get('BLUESKY_HANDLE') and os.environ.get('BLUESKY_PASSWORD'):
              bluesky.login(
                  os.environ['BLUESKY_HANDLE'],
                  os.environ['BLUESKY_PASSWORD']
              )
          
          all_comments = {}
          
          # Process all blog posts
          for post_path in glob.glob('content/posts/*.md'):
              if '_index.md' in post_path:
                  continue
                  
              with open(post_path, 'r') as f:
                  content = f.read()
              
              if not content.startswith('---'):
                  continue
                  
              parts = content.split('---', 2)
              metadata = yaml.safe_load(parts[1])
              
              if not metadata.get('social'):
                  continue
              
              post_comments = []
              
              # Fetch Bluesky replies
              bluesky_uri = metadata['social'].get('bluesky_uri')
              if bluesky_uri:
                  try:
                      # Get thread
                      thread = bluesky.get_post_thread(uri=bluesky_uri, depth=100)
                      
                      def extract_replies(post, comments_list):
                          if hasattr(post, 'replies') and post.replies:
                              for reply in post.replies:
                                  comments_list.append({
                                      'id': f'bluesky_{reply.post.uri.split("/")[-1]}',
                                      'platform': 'Bluesky',
                                      'author': reply.post.author.display_name or reply.post.author.handle,
                                      'text': reply.post.record.text,
                                      'created_at': reply.post.record.created_at,
                                      'url': f'https://bsky.app/profile/{reply.post.author.handle}/post/{reply.post.uri.split("/")[-1]}'
                                  })
                                  extract_replies(reply, comments_list)
                      
                      extract_replies(thread.thread, post_comments)
                  except Exception as e:
                      print(f"Error fetching Bluesky replies for {bluesky_uri}: {e}")
              
              # Save comments for this post
              if post_comments:
                  filename = os.path.basename(post_path).replace('.md', '')
                  all_comments[filename] = sorted(post_comments, key=lambda x: x['created_at'])
          
          # Save all comments to a data file
          os.makedirs('data', exist_ok=True)
          with open('data/comments.json', 'w') as f:
              json.dump(all_comments, f, indent=2)
          
          print(f"Fetched comments for {len(all_comments)} posts")
          EOF
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/comments.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update comments data" && git push)